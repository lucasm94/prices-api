{
  "info": {
    "_postman_id": "e1e32665-462d-424a-bf19-dd82181c00fd",
    "name": "Price Collection",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "_exporter_id": "47953592",
    "_collection_link": "https://go.postman.co/collection/47953592-e1e32665-462d-424a-bf19-dd82181c00fd?source=collection_link"
  },
  "item": [
    {
      "name": "ðŸ§ª E2E Cache Test: DB -> Redis -> Kafka",
      "item": [
        {
          "name": "Full Cache Invalidation Flow",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "const base = pm.variables.get(\"base_url\");",
                  "const priceUrl = pm.request.url.toString();",
                  "",
                  "const getMetric = (raw, type) => {",
                  "    // Flexible regex to find the metric and the 'type' tag, capturing the trailing value",
                  "    const regex = new RegExp(`api_requests_total.*type=\"${type}\".* (\\\\d+\\\\.?\\\\d*)`);",
                  "    const match = raw.match(regex);",
                  "    return match ? parseFloat(match[1]) : 0;",
                  "};",
                  "",
                  "if (pm.response.code === 200 && base) {",
                  "",
                  "    // 1. Get initial metrics state",
                  "    pm.sendRequest(`${base}/actuator/prometheus`, (err, res) => {",
                  "        if (err || res.code !== 200) return console.error(\"Prometheus is unreachable\");",
                  "",
                  "        const body = res.text();",
                  "        const nDB = getMetric(body, \"database_fetch\");",
                  "        const nInv = getMetric(body, \"cache_invalidation\");",
                  "        ",
                  "        const dateParam = pm.request.url.query.get(\"date\");",
                  "        const productIdParam = pm.request.url.query.get(\"productId\");",
                  "        const brandIdParam = pm.request.url.query.get(\"brandId\");",
                  "",
                  "        console.log(`Initial State -> DB: ${nDB} | Inval: ${nInv}`);",
                  "",
                  "        // 2. Publish Kafka event",
                  "        pm.sendRequest({",
                  "            url: `${base}/v1/internal/publish`,",
                  "            method: 'POST',",
                  "            header: { 'Content-Type': 'application/json' },",
                  "            body: { ",
                  "                mode: 'raw', ",
                  "                raw: JSON.stringify({ ",
                  "                    productId: parseInt(productIdParam), ",
                  "                    brandId: parseInt(brandIdParam),",
                  "                    date: dateParam",
                  "                }) ",
                  "            }",
                  "        }, (err, res) => {",
                  "            if (res.code !== 200) return console.error(\"Kafka publish failed\");",
                  "",
                  "            // Wait for Kafka Listener to process the eviction",
                  "            setTimeout(() => {",
                  "                ",
                  "                // 3. Third GET: Cache must be empty, forcing a DB hit",
                  "                pm.sendRequest(priceUrl, (err, res) => {",
                  "                    if (err) return console.error(\"Third GET request failed\");",
                  "",
                  "                    const priceData = res.json();",
                  "                    pm.test(\"Response contains valid data from DB\", () => {",
                  "                        pm.expect(priceData).to.have.property('productId', 35455);",
                  "                        pm.expect(priceData).to.have.property('price');",
                  "                        pm.expect(priceData.price).to.be.a('number');",
                  "                        console.log(`Price from DB: ${priceData.price} ${priceData.currency || ''}`);",
                  "                    });",
                  "",
                  "                    // Wait for Micrometer to update the Prometheus counter",
                  "                    setTimeout(() => {",
                  "                        pm.sendRequest(`${base}/actuator/prometheus`, (err, res) => {",
                  "                            const postBody = res.text();",
                  "                            const finalDB = getMetric(postBody, \"database_fetch\");",
                  "                            const finalInv = getMetric(postBody, \"cache_invalidation\");",
                  "",
                  "                            console.log(`Final State -> DB: ${finalDB} | Inval: ${finalInv}`);",
                  "",
                  "                            // Validations",
                  "                            pm.test(\"Cache was successfully invalidated via Kafka\", () => {",
                  "                                pm.expect(finalInv).to.be.above(nInv);",
                  "                            });",
                  "",
                  "                            pm.test(\"Database fetch count increased by 1\", () => {",
                  "                                pm.expect(finalDB).to.equal(nDB + 1);",
                  "                            });",
                  "                        });",
                  "                    }, 800);",
                  "                });",
                  "            }, 1500); ",
                  "        });",
                  "    });",
                  "}"
                ],
                "type": "text/javascript",
                "packages": {},
                "requests": {}
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/v1/prices?productId=35455&brandId=1&date=2020-06-14-10.00.00",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "v1",
                "prices"
              ],
              "query": [
                {
                  "key": "productId",
                  "value": "35455"
                },
                {
                  "key": "brandId",
                  "value": "1"
                },
                {
                  "key": "date",
                  "value": "2020-06-14-10.00.00"
                }
              ]
            }
          },
          "response": []
        }
      ],
      "description": "This test checks the full data lifecycle: **DB -> Redis -> Kafka -> Eviction**.\n\n**Step-by-Step Validation:**\n\n1. **First GET**: Hits the database (DB). The metric `api_requests_total` with tag `type=\"database_fetch\"` should be **N**.\n    \n2. **Second GET**: Pulls from Redis. The `database_fetch` metric **must not** increase.\n    \n3. **Invalidation (Kafka)**: A message is published. The metric with tag `type=\"cache_invalidation\"` should increase (this confirms the Kafka Listener processed the event).\n    \n4. **Third GET**: Since the cache is now empty, it hits the DB again. The `database_fetch` metric should be **N + 1**.\n    \n\n### **Prerequisites:**\n\n- Infrastructure must be running: `docker-compose up -d` (Kafka & Redis)."
    },
    {
      "name": "Get Price 200 - Without priority",
      "request": {
        "auth": {
          "type": "noauth"
        },
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/v1/prices?date=2020-06-14-10.00.00&productId=35455&brandId=1",
          "host": [
            "{{base_url}}"
          ],
          "path": [
            "v1",
            "prices"
          ],
          "query": [
            {
              "key": "date",
              "value": "2020-06-14-10.00.00",
              "description": "application date"
            },
            {
              "key": "productId",
              "value": "35455",
              "description": "product identifier"
            },
            {
              "key": "brandId",
              "value": "1",
              "description": "brand identifier (ZARA)"
            }
          ]
        }
      },
      "response": []
    },
    {
      "name": "Get Price 200 - Priority",
      "request": {
        "auth": {
          "type": "noauth"
        },
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/v1/prices?date=2020-06-14-16.00.00&productId=35455&brandId=1",
          "host": [
            "{{base_url}}"
          ],
          "path": [
            "v1",
            "prices"
          ],
          "query": [
            {
              "key": "date",
              "value": "2020-06-14-16.00.00"
            },
            {
              "key": "productId",
              "value": "35455"
            },
            {
              "key": "brandId",
              "value": "1"
            }
          ]
        }
      },
      "response": []
    },
    {
      "name": "Get Price 404 - Not Found",
      "request": {
        "auth": {
          "type": "noauth"
        },
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/v1/prices?date=2029-01-01-00.00.00&productId=35455&brandId=1",
          "host": [
            "{{base_url}}"
          ],
          "path": [
            "v1",
            "prices"
          ],
          "query": [
            {
              "key": "date",
              "value": "2029-01-01-00.00.00"
            },
            {
              "key": "productId",
              "value": "35455"
            },
            {
              "key": "brandId",
              "value": "1"
            }
          ]
        }
      },
      "response": []
    },
    {
      "name": "Get Price 400 - Invalid Date",
      "request": {
        "auth": {
          "type": "noauth"
        },
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/v1/prices?date=fecha-invalida&productId=35455&brandId=1",
          "host": [
            "{{base_url}}"
          ],
          "path": [
            "v1",
            "prices"
          ],
          "query": [
            {
              "key": "date",
              "value": "fecha-invalida"
            },
            {
              "key": "productId",
              "value": "35455"
            },
            {
              "key": "brandId",
              "value": "1"
            }
          ]
        }
      },
      "response": []
    },
    {
      "name": "Get Price 400 - Missing Product Id",
      "request": {
        "auth": {
          "type": "noauth"
        },
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/v1/prices?date=2020-06-14-10.00.00&brandId=1",
          "host": [
            "{{base_url}}"
          ],
          "path": [
            "v1",
            "prices"
          ],
          "query": [
            {
              "key": "date",
              "value": "2020-06-14-10.00.00"
            },
            {
              "key": "productId",
              "value": "",
              "disabled": true
            },
            {
              "key": "brandId",
              "value": "1"
            }
          ]
        }
      },
      "response": []
    },
    {
      "name": "Get Price 400 - Invalid Brand Id",
      "request": {
        "auth": {
          "type": "noauth"
        },
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/v1/prices?date=2020-06-14-10.00.00&productId=35455&brandId=-1",
          "host": [
            "{{base_url}}"
          ],
          "path": [
            "v1",
            "prices"
          ],
          "query": [
            {
              "key": "date",
              "value": "2020-06-14-10.00.00"
            },
            {
              "key": "productId",
              "value": "35455"
            },
            {
              "key": "brandId",
              "value": "-1"
            }
          ]
        }
      },
      "response": []
    },
    {
      "name": "Get Price 400 - Invalid Product Id",
      "request": {
        "auth": {
          "type": "noauth"
        },
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/v1/prices?date=2020-06-14-10.00.00&brandId=1&productId=a",
          "host": [
            "{{base_url}}"
          ],
          "path": [
            "v1",
            "prices"
          ],
          "query": [
            {
              "key": "date",
              "value": "2020-06-14-10.00.00"
            },
            {
              "key": "brandId",
              "value": "1"
            },
            {
              "key": "productId",
              "value": "a"
            }
          ]
        }
      },
      "response": []
    },
    {
      "name": "Get Price 400 - Invalid format date",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/v1/prices?date=2026/02/07 12:00:00&productId=35455&brandId=1",
          "host": [
            "{{base_url}}"
          ],
          "path": [
            "v1",
            "prices"
          ],
          "query": [
            {
              "key": "date",
              "value": "2026/02/07 12:00:00"
            },
            {
              "key": "productId",
              "value": "35455"
            },
            {
              "key": "brandId",
              "value": "1"
            }
          ]
        }
      },
      "response": []
    },
    {
      "name": "Post Message Kafka 200 - Cache Invalidation",
      "request": {
        "method": "POST",
        "header": [],
        "body": {
          "mode": "raw",
          "raw": "{\n    \"productId\": 35455,\n    \"brandId\": 1,\n    \"date\": \"2020-06-14-10.00.00\"\n}",
          "options": {
            "raw": {
              "language": "json"
            }
          }
        },
        "url": {
          "raw": "{{base_url}}/v1/internal/publish",
          "host": [
            "{{base_url}}"
          ],
          "path": [
            "v1",
            "internal",
            "publish"
          ]
        }
      },
      "response": []
    }
  ]
}